<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¹´í˜ POS ì¥ë¶€ v3.3</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background: #eef2f3; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        .header { background: #fff; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
        .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        input { flex: 1; padding: 15px; font-size: 1.2rem; border: 2px solid #ddd; border-radius: 10px; }
        .btn-reg { background: #333; color: white; padding: 0 20px; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        #memberList { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .card { background: #fff; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .card-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .name-area { display: flex; flex-direction: column; }
        .name { font-size: 1.6rem; font-weight: bold; }
        .phone-sub { font-size: 1rem; color: #888; }
        .balance { font-size: 2rem; font-weight: 800; color: #007bff; }
        
        /* íŠ¹ì´ì‚¬í•­ ë©”ëª¨ ìŠ¤íƒ€ì¼ */
        .member-note { background: #fff9db; padding: 8px 12px; border-radius: 8px; font-size: 0.95rem; color: #856404; margin-bottom: 15px; border: 1px dashed #ffe066; cursor: pointer; }

        /* ê¸ˆì•¡ ë²„íŠ¼ ê·¸ë¦¬ë“œ (3ì—´ì”© ë°°ì¹˜) */
        .control-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .btn-u { height: 55px; font-size: 1.1rem; font-weight: bold; border: none; border-radius: 8px; color: white; cursor: pointer; }
        .plus { background: #2ecc71; }
        .minus { background: #e74c3c; }
        .direct { background: #f39c12; grid-column: span 3; height: 45px; }
        .log-btn { background: #3498db; grid-column: span 3; height: 45px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 450px; text-align: center; }
        .log-list { max-height: 40vh; overflow-y: auto; text-align: left; border-top: 1px solid #eee; margin-top: 15px; }
        .log-item { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 0.95rem; }
        .btn-close { background: #999; color: white; border: none; padding: 12px; border-radius: 8px; margin-top: 15px; width: 100%; font-size: 1.1rem; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <div class="input-row">
        <input type="text" id="newName" placeholder="íšŒì›ëª…(ìƒˆë¡œìš´ ê³ ê°ë‹˜ ì¶”ê°€ í• ë•Œ!)">
        <input type="text" id="newPhone" placeholder="ë²ˆí˜¸(í˜•ì‹:01088646394)">
        <button class="btn-reg" onclick="addMember()">ë“±ë¡</button>
    </div>
    <div class="input-row">
        <input type="text" id="search" oninput="filter()" placeholder="ğŸ” ì´ë¦„ ë˜ëŠ” ë²ˆí˜¸ ê²€ìƒ‰">
    </div>
</div>

<div id="memberList"></div>

<div id="directModal" class="modal">
    <div class="modal-content">
        <h2 id="modalName">ê¸ˆì•¡ ì…ë ¥</h2>
        <input type="number" id="directAmount" style="width: 100%; text-align: center; font-size: 2rem; margin-bottom: 20px;" placeholder="0">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn-u plus" style="height:70px" onclick="applyDirect(true)">ì¶”ê°€(+)</button>
            <button class="btn-u minus" style="height:70px" onclick="applyDirect(false)">ì°¨ê°(-)</button>
        </div>
        <button class="btn-close" onclick="closeModal('directModal')">ë‹«ê¸°</button>
    </div>
</div>

<div id="noteModal" class="modal">
    <div class="modal-content">
        <h2>íŠ¹ì´ì‚¬í•­ ê¸°ë¡</h2>
        <input type="text" id="noteInput" style="width: 100%; padding: 15px; font-size: 1.2rem; box-sizing: border-box;" placeholder="ì˜ˆ: ìƒ·ì¶”ê°€, ì—°í•˜ê²Œ ë“±">
        <button class="btn-u plus" style="width:100%; margin-top:15px;" onclick="saveNote()">ì €ì¥í•˜ê¸°</button>
        <button class="btn-close" onclick="closeModal('noteModal')">ì·¨ì†Œ</button>
    </div>
</div>

<div id="logModal" class="modal">
    <div class="modal-content">
        <h2 id="logMemberName">ì…ì¶œê¸ˆ ê¸°ë¡</h2>
        <div id="logList" class="log-list"></div>
        <button class="btn-close" onclick="closeModal('logModal')">ë‹«ê¸°</button>
    </div>
</div>

<script>
    const SB_URL = 'https://kjoqxszmnwkmyreqysxf.supabase.co';
    const SB_KEY = 'sb_publishable_BJkRUoq6WkdevAlVjJlnLg_1jSGPRHC';
    const TABLE = 'cafe-pos'; 

    const { createClient } = supabase;
    const db = createClient(SB_URL, SB_KEY);

    let activeId = null, activeBal = 0, activeName = '';

    async function load() {
        const { data, error } = await db.from(TABLE).select('*').order('name', { ascending: true });
        if (error) return;
        
        const list = document.getElementById('memberList');
        list.innerHTML = '';
        data.forEach(m => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-info">
                    <div class="name-area">
                        <span class="name">${m.name} <span class="phone-sub">(${m.phone || ''})</span></span>
                    </div>
                    <span class="balance">${(m.balance || 0).toLocaleString()}ì›</span>
                </div>
                <div class="member-note" onclick="openNoteModal(${m.id}, '${m.note || ''}')">
                    ğŸ“ íŠ¹ì´ì‚¬í•­: ${m.note || 'íƒ­í•˜ì—¬ ê¸°ë¡ ì¶”ê°€'}
                </div>
                <div class="control-grid">
                    <button class="btn-u plus" onclick="updateBal(${m.id}, ${m.balance}, 10000)">+10000</button>
                    <button class="btn-u plus" onclick="updateBal(${m.id}, ${m.balance}, 1000)">+1000</button>
                    <button class="btn-u plus" onclick="updateBal(${m.id}, ${m.balance}, 100)">+100</button>
                    <button class="btn-u minus" onclick="updateBal(${m.id}, ${m.balance}, -10000)">-10000</button>
                    <button class="btn-u minus" onclick="updateBal(${m.id}, ${m.balance}, -1000)">-1000</button>
                    <button class="btn-u minus" onclick="updateBal(${m.id}, ${m.balance}, -100)">-100</button>
                    <button class="btn-u direct" onclick="openDirect(${m.id}, ${m.balance}, '${m.name}')">ğŸ”¢ ì§ì ‘ ì…ë ¥</button>
                    <button class="btn-u log-btn" onclick="openLog('${m.name}', \`${m.all_history || ''}\`)">ğŸ“‹ ê¸°ë¡ ë³´ê¸°</button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    async function updateBal(id, cur, amt) {
    const now = new Date();
    const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes()}`;
    const change = (amt > 0 ? '+' : '') + amt.toLocaleString();
    
    // ê¸°ë¡ ê°€ì ¸ì˜¤ê¸° ë° ìƒì„±
    const { data } = await db.from(TABLE).select('all_history').eq('id', id).single();
    const oldLog = data ? data.all_history || '' : '';
    const newLog = `${timeStr} | ${change} | ì”ì•¡: ${(cur + amt).toLocaleString()}\n` + oldLog;

    // DB ì—…ë°ì´íŠ¸
    const { error } = await db.from(TABLE)
        .update({ balance: cur + amt, all_history: newLog.substring(0, 5000) })
        .eq('id', id);

    if (error) {
        alert('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!');
    } else {
        // [í•µì‹¬ ìˆ˜ì • ë¶€ë¶„]
        await load(); // 1. ë°ì´í„°ë¥¼ ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê³ 
        filter();     // 2. í˜„ì¬ ê²€ìƒ‰ì–´ì— ë§ì¶° í™”ë©´ì„ ë‹¤ì‹œ ìˆ¨ê¹€/ë³´ì„ ì²˜ë¦¬
    }
}

    // íŠ¹ì´ì‚¬í•­ ì €ì¥
    function openNoteModal(id, currentNote) {
        activeId = id;
        document.getElementById('noteInput').value = currentNote;
        document.getElementById('noteModal').style.display = 'flex';
    }

    async function saveNote() {
    const newNote = document.getElementById('noteInput').value;
    
    // DB ì—…ë°ì´íŠ¸
    const { error } = await db.from(TABLE)
        .update({ note: newNote })
        .eq('id', activeId);

    if (error) {
        alert('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨!');
    } else {
        closeModal('noteModal');
        await load(); // 1. ë°ì´í„°ë¥¼ ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê³ 
        filter();     // 2. ê²€ìƒ‰ ìƒíƒœë¥¼ ë‹¤ì‹œ ì ìš©!
    }
}

    function openDirect(id, bal, name) {
        activeId = id; activeBal = bal; activeName = name;
        document.getElementById('modalName').innerText = name + ' ê¸ˆì•¡ì…ë ¥';
        document.getElementById('directAmount').value = '';
        document.getElementById('directModal').style.display = 'flex';
    }

    function applyDirect(isPlus) {
        const val = parseInt(document.getElementById('directAmount').value) || 0;
        if (val <= 0) return;
        updateBal(activeId, activeBal, isPlus ? val : -val);
        closeModal('directModal');
    }

    function openLog(name, history) {
        document.getElementById('logMemberName').innerText = name + ' ë‹˜ì˜ ê¸°ë¡';
        const logList = document.getElementById('logList');
        if (!history || history.trim() === "") {
            logList.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
            logList.innerHTML = history.split('\n').filter(l => l).map(l => `<div class="log-item">${l}</div>`).join('');
        }
        document.getElementById('logModal').style.display = 'flex';
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    async function addMember() {
        const n = document.getElementById('newName');
        const p = document.getElementById('newPhone');
        if (!n.value) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        await db.from(TABLE).insert([{ name: n.value, phone: p.value, balance: 0 }]);
        n.value = ''; p.value = ''; load();
    }

    function filter() {
        const t = document.getElementById('search').value.toLowerCase();
        const cards = document.getElementsByClassName('card');
        Array.from(cards).forEach(c => c.style.display = c.innerText.toLowerCase().includes(t) ? 'block' : 'none');
    }

    window.onload = load;
</script>
</body>
</html>