<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ïπ¥Ìéò POS Ïû•Î∂Ä v3.2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background: #eef2f3; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        .header { background: #fff; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
        .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        input { flex: 1; padding: 15px; font-size: 1.2rem; border: 2px solid #ddd; border-radius: 10px; }
        .btn-reg { background: #333; color: white; padding: 0 20px; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        #memberList { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .card { background: #fff; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .card-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .name-area { display: flex; flex-direction: column; }
        .name { font-size: 1.6rem; font-weight: bold; }
        .phone-sub { font-size: 1rem; color: #888; margin-top: 2px; }
        .balance { font-size: 2rem; font-weight: 800; color: #007bff; }
        .control-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .btn-u { height: 65px; font-size: 1.1rem; font-weight: bold; border: none; border-radius: 8px; color: white; cursor: pointer; }
        .plus { background: #2ecc71; }
        .minus { background: #e74c3c; }
        .direct { background: #f39c12; }
        .log-btn { background: #3498db; grid-column: span 4; height: 45px; margin-top: 5px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 450px; text-align: center; }
        .log-list { max-height: 50vh; overflow-y: auto; text-align: left; border-top: 1px solid #eee; margin-top: 15px; }
        .log-item { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 1rem; }
        .btn-close { background: #999; color: white; border: none; padding: 12px; border-radius: 8px; margin-top: 20px; width: 100%; font-size: 1.2rem; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <div class="input-row">
        <input type="text" id="newName" placeholder="ÌöåÏõêÎ™Ö">
        <input type="text" id="newPhone" placeholder="Î≤àÌò∏ (Îí∑ÏûêÎ¶¨ Îì±)">
        <button class="btn-reg" onclick="addMember()">Îì±Î°ù</button>
    </div>
    <div class="input-row">
        <input type="text" id="search" oninput="filter()" placeholder="üîç Ïù¥Î¶Ñ ÎòêÎäî Î≤àÌò∏Î°ú Í≤ÄÏÉâ">
    </div>
</div>

<div id="memberList"></div>

<div id="directModal" class="modal">
    <div class="modal-content">
        <h2 id="modalName">Í∏àÏï° ÏûÖÎ†•</h2>
        <input type="number" id="directAmount" style="width: 100%; text-align: center; font-size: 2rem; margin-bottom: 20px;" placeholder="0">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn-u plus" onclick="applyDirect(true)">Ï∂îÍ∞Ä(+)</button>
            <button class="btn-u minus" onclick="applyDirect(false)">Ï∞®Í∞ê(-)</button>
        </div>
        <button class="btn-close" onclick="closeModal('directModal')">Îã´Í∏∞</button>
    </div>
</div>

<div id="logModal" class="modal">
    <div class="modal-content">
        <h2 id="logMemberName">ÏûÖÏ∂úÍ∏à Í∏∞Î°ù</h2>
        <div id="logList" class="log-list"></div>
        <button class="btn-close" onclick="closeModal('logModal')">Îã´Í∏∞</button>
    </div>
</div>

<script>
    const SB_URL = 'https://kjoqxszmnwkmyreqysxf.supabase.co';
    const SB_KEY = 'sb_publishable_BJkRUoq6WkdevAlVjJlnLg_1jSGPRHC';
    const TABLE = 'cafe-pos'; 

    const { createClient } = supabase;
    const db = createClient(SB_URL, SB_KEY);

    let activeId = null, activeBal = 0, activeName = '';

    async function load() {
        const { data, error } = await db.from(TABLE).select('*').order('name', { ascending: true });
        if (error) return;
        
        const list = document.getElementById('memberList');
        list.innerHTML = '';
        data.forEach(m => {
            const card = document.createElement('div');
            card.className = 'card';
            // Ïù¥Î¶Ñ ÏòÜÏóê Î≤àÌò∏ Ï∂îÍ∞Ä
            card.innerHTML = `
                <div class="card-info">
                    <div class="name-area">
                        <span class="name">${m.name} <span class="phone-sub">(${m.phone || 'Î≤àÌò∏ÏóÜÏùå'})</span></span>
                    </div>
                    <span class="balance">${(m.balance || 0).toLocaleString()}Ïõê</span>
                </div>
                <div class="control-grid">
                    <button class="btn-u plus" onclick="updateBal(${m.id}, ${m.balance}, 10000)">+1Îßå</button>
                    <button class="btn-u plus" onclick="updateBal(${m.id}, ${m.balance}, 1000)">+1Ï≤ú</button>
                    <button class="btn-u minus" onclick="updateBal(${m.id}, ${m.balance}, -1000)">-1Ï≤ú</button>
                    <button class="btn-u direct" onclick="openDirect(${m.id}, ${m.balance}, '${m.name}')">ÏßÅÏ†ë</button>
                    <button class="btn-u log-btn" onclick="openLog('${m.name}', \`${m.all_history || ''}\`)">üìã Í∏∞Î°ù Î≥¥Í∏∞</button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    async function updateBal(id, cur, amt) {
        const now = new Date();
        const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes()}`;
        const change = (amt > 0 ? '+' : '') + amt.toLocaleString();
        
        const { data } = await db.from(TABLE).select('all_history').eq('id', id).single();
        const oldLog = data ? data.all_history || '' : '';
        const newLog = `${timeStr} | ${change} | ÏûîÏï°: ${(cur + amt).toLocaleString()}Ïõê\n` + oldLog;

        await db.from(TABLE).update({ balance: cur + amt, all_history: newLog.substring(0, 5000) }).eq('id', id);
        load();
    }

    function openDirect(id, bal, name) {
        activeId = id; activeBal = bal; activeName = name;
        document.getElementById('modalName').innerText = name + ' Í∏àÏï°ÏûÖÎ†•';
        document.getElementById('directAmount').value = '';
        document.getElementById('directModal').style.display = 'flex';
    }

    function applyDirect(isPlus) {
        const val = parseInt(document.getElementById('directAmount').value) || 0;
        if (val <= 0) return;
        updateBal(activeId, activeBal, isPlus ? val : -val);
        closeModal('directModal');
    }

    function openLog(name, history) {
        document.getElementById('logMemberName').innerText = name + ' ÎãòÏùò Í∏∞Î°ù';
        const logList = document.getElementById('logList');
        if (!history || history.trim() === "") {
            logList.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
        } else {
            logList.innerHTML = history.split('\n').filter(l => l).map(l => `<div class="log-item">${l}</div>`).join('');
        }
        document.getElementById('logModal').style.display = 'flex';
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    async function addMember() {
        const n = document.getElementById('newName');
        const p = document.getElementById('newPhone');
        if (!n.value) return alert('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
        await db.from(TABLE).insert([{ name: n.value, phone: p.value, balance: 0 }]);
        n.value = ''; p.value = ''; load();
    }

    function filter() {
        const t = document.getElementById('search').value.toLowerCase();
        const cards = document.getElementsByClassName('card');
        Array.from(cards).forEach(c => c.style.display = c.innerText.toLowerCase().includes(t) ? 'block' : 'none');
    }

    window.onload = load;
</script>
</body>
</html>